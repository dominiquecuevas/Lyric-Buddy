{% extends 'base.html' %}

{% block title %}Lyrics{% endblock %}

{% block script %}
<!-- Load jQuery -->
<script src="http://code.jquery.com/jquery-latest.js"></script>
<!-- Load jQuery.selection plugin-->
<script type="text/javascript" src="static/jquery.selection.js"></script>
{% endblock %}

{% block content %}
    <form id="searchForm">
        <input id="searchTerm" type="text"><br>
        <input id="search" type="submit" value="Search">
    </form>

    <h1>Results</h1>

    <iframe id="ytplayer" type="text/html" width="640" height="360" 
    frameborder="0"></iframe>

<!-- DISABLING JINJA VARIABLES TO REFACTOR TO  -->
    <h2 id="title"></h2>
    <h3 id="artist"></h3>
    <p id="lyrics">
        <!-- jinja block to pass through html code -->

        {% autoescape false %}

        {% endautoescape %}
    </p>

    <p>
    <!-- while text selected, click button to  -->
    <input type="button" id="get-fragment" value="Get song fragment" />
    </p>

    <div id="annotation">
    <form action="/save" method="POST">
    Fragment <textarea id="fragment" name='fragment'></textarea><br>
    Annotation <textarea name='annotation'></textarea><br>
    <input type='hidden' name='song_title' value="">
    <input type='hidden' name='song_artist' value="">
    <input type='hidden' name='lyrics' value="">
    <input type='hidden' name='video_url' value="">
    <input type='submit' value='Save'>
    </form>

    <table id="q_annotations">
        <!-- append rows from query -->
    </table>
    </div>

    <script>

    // const fragment = $('fragment').attr('value')
    // Get selected text
    // when get-fragment button is clicked, put the selected text in textarea

    $('#get-fragment').on('click', function(){
        $('#lyrics').focus();
        $('#fragment').text($.selection());

    });

    </script>

    <script>
    $('#search').on('click', (evt) => {
        evt.preventDefault();
        // $('#lyrics').html('bye<br>bye<br>');

        // $('#q_annotations').append('<tr>test append to table</tr>');

        const q = $('#searchTerm').val();
        $.get(`/api/search?q=${q}`, (res) => {
            $('#lyrics').html(res.lyrics);
            $('input[name="lyrics"]').val(res.lyrics);

            // TODO: do that stuff up there ^^^^ but for everything else :D

            $('#title').html(res.song_title);
            $('input[name="song_title"]').val(res.song_title);

            $('#artist').html(res.song_artist);
            $('input[name="song_artist"]').val(res.song_artist);
            
            $('input[name="video_url"]').val(res.video_url);
            $('iframe').attr('src', `https://www.youtube.com/embed/${res.video_url}?autoplay=0`);

            // if there are annotations, not None
            // clear out values
            // get q_annotations from json, is a list of tuples
                // loop over list 
                // index into tuples, add a row 'tr'
                // td's for fragment and annotation in row

            $('#q_annotations').empty();
            if (res.song_annos.length) {
                $('#q_annotations').append('<tr><th>Fragment</th><th>Annotation</th></tr>');
                for (const song_anno of res.song_annos) {
                    $('#q_annotations').append(`<tr id="${song_anno[0]}"></tr>`);
                    $(`#${song_anno[0]}`).append(`<td>${song_anno[1]}</td>`);
                    $(`#${song_anno[0]}`).append(`<td>${song_anno[2]}</td>`);
                };
            };
        });
    });

    </script>
{% endblock %}